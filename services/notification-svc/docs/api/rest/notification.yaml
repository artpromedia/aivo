openapi: 3.1.0
info:
  title: Realtime Notification Service
  description: |
    WebSocket, Web Push, and SMS notification service for IEP reminders and educational alerts.

    ## Features
    - **WebSocket**: Real-time bidirectional communication with JWT auth
    - **Web Push**: Browser push notifications for offline users
    - **SMS Fallback**: Critical notifications via SMS when other channels fail
    - **IEP Reminders**: Specialized templates for IEP meetings and deadlines
    - **Localized Templates**: Multi-language support for notifications

    ## Authentication
    - JWT tokens required for WebSocket connections
    - Bearer token authentication for REST endpoints

    ## Message Flow
    ```
    Client  WebSocket  Notification Service  Message Queue

           Web Push API            SMS Provider
    ```
  version: 1.0.0
  contact:
    name: Realtime Engineering Team
    email: engineering@aivo.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8003
    description: Development server
  - url: https://notifications.aivo.com
    description: Production server

paths:
  /ws/notify:
    get:
      summary: WebSocket endpoint for real-time notifications
      description: |
        Establishes WebSocket connection for real-time notification delivery.
        Requires JWT token in query parameter or Authorization header.

        **Features:**
        - JWT authentication with user context
        - Heartbeat mechanism (ping/pong every 30s)
        - Message replay with replay-id for missed messages
        - Automatic reconnection handling
        - IEP reminder delivery

        **Message Format:**
        ```json
        {
          "id": "uuid",
          "type": "iep_reminder|meeting_alert|deadline_warning",
          "data": {...},
          "timestamp": "2025-09-11T10:00:00Z",
          "replay_id": "12345"
        }
        ```
      parameters:
        - name: token
          in: query
          description: JWT authentication token
          required: true
          schema:
            type: string
            format: jwt
        - name: replay_from
          in: query
          description: Replay messages from this ID
          required: false
          schema:
            type: string
      responses:
        '101':
          description: WebSocket connection established
        '401':
          description: Unauthorized - Invalid JWT token
        '403':
          description: Forbidden - Token expired or invalid
      tags:
        - WebSocket

  /push/subscribe:
    post:
      summary: Subscribe to web push notifications
      description: |
        Register a browser push subscription for offline notification delivery.
        Stores subscription endpoint and keys for later push message delivery.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PushSubscription'
            example:
              endpoint: "https://fcm.googleapis.com/fcm/send/..."
              keys:
                p256dh: "BNcRdreALRFXTkOOUHK1EtK2wtaz5Ry4YfYCA_0QTpQtUbVlUls0VJXg7A8u-Ts1XbjhazAkj7I99e8QcYP7DkM="
                auth: "tBHItJI5svbpez7KI4CCXg=="
      responses:
        '200':
          description: Push subscription registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Push subscription registered"
                  subscription_id:
                    type: string
                    format: uuid
        '400':
          description: Bad request - Invalid subscription data
        '401':
          description: Unauthorized - Missing or invalid token
      tags:
        - Push Notifications

  /push/unsubscribe:
    delete:
      summary: Unsubscribe from web push notifications
      description: Remove push subscription for the authenticated user
      security:
        - bearerAuth: []
      parameters:
        - name: endpoint
          in: query
          description: Push subscription endpoint to remove
          required: true
          schema:
            type: string
            format: uri
      responses:
        '200':
          description: Push subscription removed successfully
        '404':
          description: Subscription not found
        '401':
          description: Unauthorized
      tags:
        - Push Notifications

  /notify:
    post:
      summary: Send notification via multiple channels
      description: |
        Send notifications through available channels (WebSocket, Push, SMS).
        Supports IEP reminders, meeting alerts, and educational notifications.

        **Channel Priority:**
        1. WebSocket (if user is online)
        2. Web Push (if subscription exists)
        3. SMS (for critical notifications only)

        **IEP Reminder Types:**
        - `iep_meeting_reminder`: Upcoming IEP meeting notifications
        - `iep_deadline_warning`: IEP review deadline alerts
        - `iep_document_ready`: IEP documentation completion
        - `iep_parent_consent`: Parent consent requests
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationRequest'
            examples:
              iep_meeting_reminder:
                summary: IEP Meeting Reminder
                value:
                  user_id: "123e4567-e89b-12d3-a456-426614174000"
                  template_id: "iep_meeting_reminder"
                  notification_type: "iep_reminder"
                  channels: ["websocket", "push", "sms"]
                  priority: "high"
                  data:
                    student_name: "Sarah Johnson"
                    meeting_date: "2025-09-15T14:00:00Z"
                    location: "Conference Room A"
                    attendees: ["Teacher", "Parent", "Counselor"]
                  locale: "en-US"
                  phone_number: "+1234567890"
                  ttl: 86400
              deadline_warning:
                summary: IEP Deadline Warning
                value:
                  user_id: "123e4567-e89b-12d3-a456-426614174000"
                  template_id: "iep_deadline_warning"
                  notification_type: "deadline_alert"
                  channels: ["websocket", "push"]
                  priority: "critical"
                  data:
                    student_name: "Michael Chen"
                    deadline_date: "2025-09-20T23:59:59Z"
                    days_remaining: 5
                    action_required: "Submit IEP review documents"
                  locale: "en-US"
      responses:
        '200':
          description: Notification sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationResponse'
        '400':
          description: Bad request - Invalid notification data
        '401':
          description: Unauthorized
        '500':
          description: Internal server error - Notification delivery failed
      tags:
        - Notifications

  /templates:
    get:
      summary: List available notification templates
      description: Get list of available templates for IEP and educational notifications
      security:
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          description: Filter templates by category
          schema:
            type: string
            enum: [iep_reminders, meeting_alerts, deadline_warnings, general]
        - name: locale
          in: query
          description: Filter templates by locale
          schema:
            type: string
            example: "en-US"
      responses:
        '200':
          description: List of available templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  templates:
                    type: array
                    items:
                      $ref: '#/components/schemas/NotificationTemplate'
      tags:
        - Templates

  /analytics:
    get:
      summary: Get notification analytics
      description: Retrieve notification delivery statistics and performance metrics
      security:
        - bearerAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
        - name: notification_type
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Analytics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationAnalytics'
      tags:
        - Analytics

  /health:
    get:
      summary: Health check endpoint
      description: Service health status and connection metrics
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                  connections:
                    type: integer
                    description: Active WebSocket connections
                  version:
                    type: string
                    example: "1.0.0"
      tags:
        - Health

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    PushSubscription:
      type: object
      required: [endpoint, keys]
      properties:
        endpoint:
          type: string
          format: uri
          description: Push service endpoint URL
          example: "https://fcm.googleapis.com/fcm/send/..."
        keys:
          type: object
          required: [p256dh, auth]
          properties:
            p256dh:
              type: string
              description: P256DH public key for encryption
            auth:
              type: string
              description: Authentication secret
          example:
            p256dh: "BNcRdreALRFXTkOOUHK1EtK2wtaz5Ry4YfYCA_0QTpQtUbVlUls0VJXg7A8u-Ts1XbjhazAkj7I99e8QcYP7DkM="
            auth: "tBHItJI5svbpez7KI4CCXg=="

    NotificationRequest:
      type: object
      required: [user_id, template_id, notification_type, channels, data]
      properties:
        user_id:
          type: string
          format: uuid
          description: Target user ID
        template_id:
          type: string
          description: Notification template identifier
          enum:
            - iep_meeting_reminder
            - iep_deadline_warning
            - iep_document_ready
            - iep_parent_consent
            - meeting_alert
            - general_reminder
        notification_type:
          type: string
          description: Type of notification for categorization
          enum: [iep_reminder, meeting_alert, deadline_warning, document_notification, general]
        channels:
          type: array
          items:
            type: string
            enum: [websocket, push, sms]
          description: Preferred delivery channels in order
        priority:
          type: string
          enum: [low, normal, high, critical]
          default: normal
          description: Notification priority level
        data:
          type: object
          description: Template data for personalization
          properties:
            student_name:
              type: string
            meeting_date:
              type: string
              format: date-time
            deadline_date:
              type: string
              format: date-time
            location:
              type: string
            attendees:
              type: array
              items:
                type: string
            action_required:
              type: string
            days_remaining:
              type: integer
        locale:
          type: string
          default: "en-US"
          description: Locale for message localization
          example: "en-US"
        phone_number:
          type: string
          description: Phone number for SMS fallback
          example: "+1234567890"
        ttl:
          type: integer
          description: Time to live in seconds
          default: 86400
        queue_if_offline:
          type: boolean
          default: true
          description: Queue message if user is offline

    NotificationResponse:
      type: object
      properties:
        notification_id:
          type: string
          format: uuid
          description: Unique notification identifier
        channels:
          type: object
          description: Delivery status for each channel
          properties:
            websocket:
              type: string
              enum: [delivered, user_offline, failed]
            push:
              type: string
              enum: [delivered, no_subscription, failed]
            sms:
              type: string
              enum: [delivered, no_phone_number, failed, rate_limited]
        queued:
          type: boolean
          description: Whether message was queued for later delivery
        estimated_delivery:
          type: string
          format: date-time
          description: Estimated delivery time for queued messages

    NotificationTemplate:
      type: object
      properties:
        id:
          type: string
          description: Template identifier
        name:
          type: string
          description: Human-readable template name
        category:
          type: string
          enum: [iep_reminders, meeting_alerts, deadline_warnings, general]
        description:
          type: string
          description: Template description
        required_data:
          type: array
          items:
            type: string
          description: Required data fields for template
        supported_locales:
          type: array
          items:
            type: string
          description: Supported locale codes
        channel_support:
          type: object
          properties:
            websocket:
              type: boolean
            push:
              type: boolean
            sms:
              type: boolean

    NotificationAnalytics:
      type: object
      properties:
        total_notifications:
          type: integer
          description: Total notifications sent
        delivery_stats:
          type: object
          properties:
            websocket:
              $ref: '#/components/schemas/ChannelStats'
            push:
              $ref: '#/components/schemas/ChannelStats'
            sms:
              $ref: '#/components/schemas/ChannelStats'
        notification_types:
          type: object
          additionalProperties:
            type: integer
          description: Count by notification type
        response_times:
          type: object
          properties:
            average_ms:
              type: number
            p95_ms:
              type: number
            p99_ms:
              type: number

    ChannelStats:
      type: object
      properties:
        sent:
          type: integer
        delivered:
          type: integer
        failed:
          type: integer
        success_rate:
          type: number
          format: float
          minimum: 0
          maximum: 1

    WebSocketMessage:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique message identifier
        type:
          type: string
          enum: [iep_reminder, meeting_alert, deadline_warning, heartbeat, ack]
        data:
          type: object
          description: Message payload
        timestamp:
          type: string
          format: date-time
        replay_id:
          type: string
          description: Sequence ID for message replay
        user_id:
          type: string
          format: uuid

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details
        timestamp:
          type: string
          format: date-time

tags:
  - name: WebSocket
    description: Real-time WebSocket notification delivery
  - name: Push Notifications
    description: Web Push notification management
  - name: Notifications
    description: Multi-channel notification sending
  - name: Templates
    description: Notification template management
  - name: Analytics
    description: Notification delivery analytics
  - name: Health
    description: Service health monitoring
